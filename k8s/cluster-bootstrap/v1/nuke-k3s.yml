---
- name: Nuke k3s cluster more safely
  hosts: k3s_nodes
  become: yes
  gather_facts: no
  order: sorted # Ensures masters are processed before agents, if that matters for other tasks
  tasks:
    - name: Run k3s-uninstall.sh on masters
      ansible.builtin.command: /usr/local/bin/k3s-uninstall.sh
      args:
        removes: /usr/local/bin/k3s-uninstall.sh
      when: inventory_hostname in groups['k3s_masters']
      ignore_errors: yes

    - name: Run k3s-agent-uninstall.sh on agents
      ansible.builtin.command: /usr/local/bin/k3s-agent-uninstall.sh
      args:
        removes: /usr/local/bin/k3s-agent-uninstall.sh
      when: inventory_hostname in groups['k3s_agents']
      ignore_errors: yes

    - name: Forcefully stop and disable k3s services
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
        enabled: no
      with_items:
        - "k3s"
        - "k3s-agent"
      ignore_errors: yes

    - name: Clean up known CNI interfaces
      # This is the crucial step. We manually delete interfaces that the
      # uninstall script might miss. The '|| true' prevents failure if they don't exist.
      ansible.builtin.shell: |
        ip link delete cni0 || true
        ip link delete flannel.1 || true
        # Add other CNI interfaces here if you use a different CNI, e.g., 'cali...' for Calico
      ignore_errors: yes

    - name: Flush all iptables rules
      # k3s heavily uses iptables. A standard flush is essential.
      ansible.builtin.shell: |
        iptables -F
        iptables -X
        iptables -t nat -F
        iptables -t nat -X
        iptables -t mangle -F
        iptables -t mangle -X
        iptables -P INPUT ACCEPT
        iptables -P FORWARD ACCEPT
        iptables -P OUTPUT ACCEPT
      ignore_errors: yes

    - name: Remove k3s related directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      with_items:
        - "/etc/rancher"
        - "/var/lib/rancher"
        - "/var/lib/kubelet"
        - "/etc/cni" # Remove the whole /etc/cni directory

    - name: Reboot nodes to apply clean state
      ansible.builtin.reboot:
        reboot_timeout: 3600
