---
# tasks file for helm_charts

### --- Repository Additions --- ###
#
# - name: Add the Sealed Secrets Helm repository
#   kubernetes.core.helm_repository:
#     name: sealed-secrets
#     repo_url: "https://bitnami-labs.github.io/sealed-secrets"
#   become: no

- name: Add the Longhorn Helm repository
  kubernetes.core.helm_repository:
    name: longhorn
    repo_url: "https://charts.longhorn.io"
  become: no

- name: Add the HashiCorp Helm repository
  kubernetes.core.helm_repository:
    name: hashicorp
    repo_url: "https://helm.releases.hashicorp.com"
  become: no

- name: Add the External Secrets Helm repository
  kubernetes.core.helm_repository:
    name: external-secrets
    repo_url: "https://charts.external-secrets.io"
  become: no

#### --- Chart Installations --- ###
  #
# - name: Install Sealed Secrets Helm chart
#   kubernetes.core.helm:
#     name: sealed-secrets
#     chart_ref: sealed-secrets/sealed-secrets
#     release_namespace: kube-system
#     create_namespace: yes
#     wait: yes
#   become: no

- name: Install Longhorn Helm chart
  kubernetes.core.helm:
    name: longhorn
    chart_ref: longhorn/longhorn
    release_namespace: longhorn-system
    create_namespace: yes
    wait: yes
  become: no

- name: Install HashiCorp Vault Helm chart
  kubernetes.core.helm:
    name: vault
    chart_ref: hashicorp/vault
    release_namespace: vault
    create_namespace: yes
    wait: yes
    values:
      server:
        ha:
          enabled: false
  become: no

# --- External Secrets Operator Installation (with separate CRD task) ---

- name: Install External Secrets CRDs using Server-Side Apply
  kubernetes.core.k8s:
    state: present
    # This ensures your CRDs match the operator version you intend to run.
    src: "https://github.com/external-secrets/external-secrets/releases/download/v0.9.9/crds.yaml"
    server_side_apply:
      # Enable Server-Side apply
      enabled: true
      # A unique name to identify the manager of these fields
      field_manager: "ansible-playbook"
  become: no

- name: Install External Secrets Operator Helm chart
  kubernetes.core.helm:
    name: external-secrets
    chart_ref: external-secrets/external-secrets
    # You can pin the chart version to match the CRD version for full consistency
    chart_version: "0.9.9"
    release_namespace: external-secrets
    create_namespace: yes
    wait: yes
    values:
      # We tell the chart not to manage CRDs
      installCRDs: false
  become: no
